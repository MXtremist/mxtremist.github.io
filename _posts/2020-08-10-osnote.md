---
layout: post
title: 操作系统复习笔记
date: 2020-08-10
Author: MXtremist
categories: 
tags: [note, study]

comments: true
--- 
# 概论

## 操作系统的任务

- 自顶向下：为应用开发人员提供简洁易用的资源抽象
- 自底向上：管理种类繁多、纷繁复杂的硬件资源
- 自底向上：管理种类繁多、纷繁复杂的硬件资源

并发性，指两个或两个以上的事件或活动在同一时间间隔内发生

并行性，指两个或两个以上事件或活动在同一时刻发生，是并发的特例

## 操作系统的特征

并发性、共享性（系统中的资源可被多个并发执行的任务（作业）所使用，互斥or同时）、异步性（能处理随机事件）、虚拟性（是操作系统的一种管理技术）

## 系统调用

应用程序请求内核操作系统服务的过程

用户触发system call，之后跳转到系统的相应处理函数

系统调用提供进程管理、文件操作、内存管理、进程通信、信息维护等

## 内核

操作系统的基本元素：内核、进程（资源分配和调度的单位）、线程（调度的单位）

内核分为微内核、单内核

基本功能：中断处理、时钟管理、短程调度（分配处理器，完成保护和恢复现场）、原语管理（通信原语、IO设备原语等）

# 处理器管理

## 处理器

### 指令

特权指令：有关资源管理、只能由操作系统执行

（仅在内核态下执行）

### 处理器状态

内核态&用户态

用户态→内核态：系统调用、中断、异常

### 栈

用户栈：保存应用程序的子程序间相互调用的参数、返回值、返回点、子程序的局部变量

内核栈/系统栈：保存中断现场/保存操作系统持续间相互调用的参数、返回值、返回点、局部变量

栈指针只有一个

### 程序状态字PSW

存放在EFLAGS里，分为状态标志（OF、SF等）、控制标志（IF中断允许等）、系统标志（管理进程）

## 中断技术

> 中断是指程序执行过程中，遇到急需处理的事件时，暂时中止CPU上现行程序的运行，转去执行相应的事件处理程序，待处理完成后再返回原程序被中断处或调度其他程序执行的过程。

- 请求系统服务—系统调用
- 实现并发工作
- 处理突发事件
- 满足实时要求

### 中断源分类

- 硬中断（硬件产生）（上半部分）
- 软中断（信号、软件中断）（下半部分）



- 外中断（中断、异步）
- 内中断（异常、同步）（错误、陷阱、终止）

#### 硬、软中断的区别

硬中断是由外设引发的，由中断控制器提供中断号、可屏蔽、属于上半部分；

软中断是执行中断指令（int）产生的，不可屏蔽，属于下半部分；

#### 中断、异常的区别

中断是异步的（指令间），异常是同步的（一条指令执行期间）

一般来说，中断处理程序提供的服务不是为当前进程所需的，而异常处理程序提供的服务是为当前进程所用

### 中断事件的产生

硬件故障中断、程序性中断（语法错误、逻辑错误、异常）、I/O中断、访管中断（通过陷入指令调用操作系统内核程序）、时钟中断

### 中断优先级

当产生高优先级的中断时，应屏蔽比它优先级低的所有中断源（不响应这些）

确保高优先级可以打断低优先级中断，反之不能

要防止同级中断互相干扰，屏蔽同级的中断

开中断后，系统就可以响应其他的中断了，关中断后，系统不响应其他的中断（除非优先级高）

### 响应及服务

- 发现中断源

- 保护现场

- 转向处理中断/异常事件的处理程序

- 恢复现场

### 处理流程

#### 中断

1. 设备发出中断请求，中断控制器将中断号转换成中断向量存储I/O寄存器
2. CPU根据中断向量号在IDT（中断描述符表）中找到中断服务程序的入口地址
3. 保护现场：将CPU寄存器的值压入核心栈
4. 对中断控制器进行确认，设置中断源状态等
5. 提供服务
6. 退出，恢复现场

#### 异常

1. 转向异常处理程序公共入口
2. 将硬件错误码和异常向量号存入当前进程PCB中
3. 判别异常产生于核心态还是用户态
4. 对于核心态，将简单地转向内核预定义服务程序处理，没有被处理的核心态异常是操作系统的致命错误
5. 对于用户态异常，终止当前进程运行,并给当前进程发信号
6. 从ret_from_exception处返回用户空间时，检查进程是否有信号等待处理，如果有则根据信号类型调用相应函数进行处理

#### Linux中断处理

##### 快、慢

Linux将中断分为快中断和慢中断

|     **慢中断**     |           **快中断**            |
| :----------------: | :-----------------------------: |
|   保存所有寄存器   | 只保存常规c函数可以修改的寄存器 |
| 处理结束，重新调度 |      处理结束，返回原进程       |

慢中断分为上下部分，上半部分关中断、下半部分开中断；快中断关中断

##### 下半部分实现方式

BH数组（只支持32个，只能同步）、任务队列（无法并行）、软中断（可并行）、小任务（基于软中断实现）、工作队列（如果下半部分需要阻塞、获取信号量或大量主存时）

##### IDT

每一个中断/异常对应一个表项（门描述符）

中断门：关中断的中断或异常处理

陷阱门：开中断的异常处理

系统门：系统调用

IDTR寄存器存放IDT的起始地址

## 进程和线程

### 进程

#### 定义和属性

原理角度：支持程序执行的系统机制

实现角度：刻画运行程序的状态和系统动态变化状况的数据结构

主要目的：

- 刻画程序的并发性
- 解决资源的共享性

属性：

- 动态性：程序的一次执行过程
- 共享性：多个不同进程可执行同一程序
- 独立性：每个进程是独立的实体
- 结构性：分为数据块、代码块、控制块、核心栈
- 制约性：进程间相互制约
- 并发性：在时间上可重叠

#### 描述和组成

##### 进程状态转换

三态模型：

<img src="https://i.loli.net/2020/08/16/xU6LvAgpItFoEqW.png" alt="Q1B6LOIMOTMBK0_CXNWYY_X.png" style="zoom:50%;" />





七态模型：

<img src="https://i.loli.net/2020/08/16/BAZYV6M7OJokWbQ.png" alt="9__3KM_6_J38_5__2R5U3_R.png" style="zoom: 80%;" />



##### 进程上下文

进程物理实体和支持进程运行的环境合称进程上下文，系统调度产生进程上下文切换

用户级上下文、寄存器上下文、系统级上下文

##### 进程控制块PCB

含有：

- 标识信息：进程ID、进程名、进程组ID、用户组名等
- 现场信息：通用寄存器、控制寄存器内容、栈指针、程序状态字等
- 控制信息：进程优先级、时间片剩余量等，用于管理和控制调度

##### 进程队列的方式

链接方式：链表等

索引方式：通过PCB号建立索引表

#### 进程的控制

##### 上下文切换

切换只能在内核态

切换时机：主动调度（例如执行write、read等）、被动调度（时间片用完等）

切换步骤：

- 保存被中断进程的处理器现场信息
- 修改被中断进程的进程控制块的有关信息，如进程状态等
- 把被中断进程的进程控制块加入有关队列
- 选择下一个占有处理器运行的进程
- 修改被选中进程的进程控制块的有关信息
- 根据被选中进程设置操作系统用到的地址转换和存储保护信息
- 根据被选中进程恢复处理器现场

##### 处理器状态转换

用户态 $\rightleftharpoons $ 内核态

### 线程

#### 为什么引入线程

减少进程并发执行时所付出的时空开销，使得并发粒度更细、并发性更好

#### 进程与线程

- 进程：保护和资源分配的基本单位，无需频繁切换

- 线程：处理器调度和分配的基本单位，体量小（轻量级线程），频繁切换
- 同一进程中的所有线程共享进程获得的主存空间和资源

<img src="https://i.loli.net/2020/08/16/lxrHTFM8kfW914n.png" alt="0``1_F3YB0W_7N~G_CM_1SL.png" style="zoom:50%;" />

#### 线程的组成与状态

##### 组成

- 线程惟一标识符及线程状态信息；

- 未运行时保存的线程上下文

- 核心栈：核心态下工作时，保存参数，函数调用时的返回地址等；

- 私有存储区：用于存放线程局部变量及用户栈。

##### 状态

运行、就绪、堵塞（无挂起）

#### 线程的实现

##### 用户级线程

用户程序来管理线程

优点：切换快，无需OS支持

缺点：管理程序堵塞导致所有线程被堵塞

##### 内核级线程

内核完成

##### 混合线程

![N_L7BEMT6HJXQ5X_9MRGA_V.png](https://i.loli.net/2020/08/16/7EOiWUYVTnxyujr.png)

## 处理器调度



# **同步、通信、死锁**

# **文件系统**

# **存储管理**

# **设备管理**



**最后修改于2020/8/16**